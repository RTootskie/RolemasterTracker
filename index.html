<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <title>Rolemaster Tracker</title>
        <link rel="stylesheet" href="main.css">
    </head>
    <body>
        <h1>Rolemaster Tracker</h1>
        <p>Making tracking easier</p>
        <div id="notification"></div>
        <div id="menu-buttons">
            <nav>
                <button id="backup">Save File</button>
                <button id="load">Load File</button>
                <ul>
                    <li><button id="reshuffle">Reshuffle</button> - <p>Reorder templates by AT Q</p></li>
                    <li><button id="clear">Clear Tracker</button> - <p>Empty the tracker</p></li>
                    <li id="save_button"><button id="save">Save Current</button> - <p>Update local storage</p></li>
                    <li>Round <p id="current_round">1</p>/<p id="total_round">1</p> - <p>Round count</p></li>
                    <li><button id="previous">Previous Round</button> - <p>Go back a round</p></li>
                    <li><button id="next">Next Round</button> - <p>Go forward a round</p></li>
                </ul>
            </nav>
        </div>
        <div id="tracker-objects">
            <div id="objects"></div>
            <button id="add_object">+</button>
        </div>
        <script>
            var charObject;
            var accessData;
            var objectTemplate = "<ul id='first_row'>" +
                                        "<li>Name: <input id='char_name'></input></li>" +
                                        "<li>AT Q: <input id='char_quick' type='number'></input></li>" +
                                        "<li>Bleed Amt. <input id='char_bleedamt' type='number'></input></li>" +
                                        "<li>Bleed Dur. <input id='char_bleeddur' type='number'></input></li>" +
                                    "</ul>" +
                                    "<ul id='sec_row'>" +
                                        "<li>Total HP: <input id='char_totalhp' type='number'></input></li>" +
                                        "<li>Curr. HP: <input id='char_currhp' type='number'></input></li>" +
                                        "<li>Total PP: <input id='char_totalpp' type='number'></input></li>" +
                                        "<li>Curr. PP: <input id='char_currpp' type='number'></input></li>" +
                                        "<li>Stun Dur. <input id='char_stun' type='number'></input></li>" +
                                    "</ul>" +
                                    "<ul id='third_row'>" +
                                        "<li>Knocked Down: <input id='char_knock' type='checkbox'></input></li>" +
                                        "<li>Asleep: <input id='char_asleep' type='checkbox'></input></li>" +
                                        "<li>Disarmed: <input id='char_disarm' type='checkbox'></input></li>" +
                                        "<li>Forced Parry: <input id='char_parry' type='number'></input></li>" +
                                        "<li>Penalty: <input id='char_penalty' type='number'></input></li>" +
                                    "</ul>" +
                                    "</div>"

            var jsonTemplate = {
                                "name":"",
                                "Attack Quickness": null,
                                "Bleed Amount": null,
                                "Bleed Duration": null,
                                "Total HP": null,
                                "Current HP": null,
                                "Total Power": null,
                                "Current Power": null,
                                "Stun Duration": null,
                                "Knocked Down": false,
                                "Asleep": false,
                                "Disarmed": false,
                                "Forced Parry": null,
                                "Penalty": null
                                }

            $(document).ready(function() {
                var current_round = 1;
                var total_round = 1;
                $("#current_round").text(current_round);
                $("#total_round").text(total_round);
                $.getJSON('storage.json', function(charJsonObject) {
                    // Get the round
                    $.each(charJsonObject, function(index, value) {
                        // Get the characters
                        $.each(value, function(index, value) {
                            // Get the first character
                            $.each(value, function(index, value) {
                                $("#objects").append("<div id='object_template_1'>" +
                                                    objectTemplate);
                                if (localStorage.getItem('charObject') == null || localStorage.getItem('charObject') === undefined) {
                                    var createCharObject;
                                    $.getJSON('storage.json', function(charJson) {
                                        $.each(charJson, function(index, value) {
                                            createCharObject = value;
                                            localStorage.setItem('charObject', JSON.stringify(createCharObject));    
                                            charObject = localStorage.getItem('charObject');
                                            accessData = $.parseJSON(charObject);
                                        });
                                    });
                                } else {
                                    charObject = localStorage.getItem('charObject');
                                    accessData = $.parseJSON(charObject);
                                    var charData;
                                    var charNumber;
                                    $.each(JSON.parse(charObject), function(index, value) {
                                        
                                        charData = value;
                                        if (index > current_round) {
                                            current_round = index;
                                            total_round = index;
                                            $("#current_round").text(current_round);
                                            $("#total_round").text(total_round);
                                        }
                                        $.each(value, function(index, value) {
                                            $.each(value, function(index, value) {
                                                if ($(`#object_template_${index}`).length === 0) {
                                                    $("#objects").append("<div id='object_template_"+index+"'>" +
                                                        objectTemplate);
                                                }
                                                console.log(charData["characters"][index]["Knocked Down"]);
                                                $(`#object_template_${index} #char_name`).val(charData["characters"][index]["Name"]);
                                                $(`#object_template_${index} #char_quick`).val(charData["characters"][index]["Attack Quickness"]);
                                                $(`#object_template_${index} #char_bleedamt`).val(charData["characters"][index]["Bleed Amount"]);
                                                $(`#object_template_${index} #char_bleeddur`).val(charData["characters"][index]["Bleed Duration"]);
                                                $(`#object_template_${index} #char_totalhp`).val(charData["characters"][index]["Total HP"]);
                                                $(`#object_template_${index} #char_currhp`).val(charData["characters"][index]["Current HP"]);
                                                $(`#object_template_${index} #char_totalpp`).val(charData["characters"][index]["Total Power"]);
                                                $(`#object_template_${index} #char_currpp`).val(charData["characters"][index]["Current Power"]);
                                                $(`#object_template_${index} #char_stun`).val(charData["characters"][index]["Stun Duration"]);
                                                $(`#object_template_${index} #char_knock`).val(charData["characters"][index]["Knocked Down"]);
                                                $(`#object_template_${index} #char_asleep`).val(charData["characters"][index]["Asleep"]);
                                                $(`#object_template_${index} #char_disarm`).val(charData["characters"][index]["Disarmed"]);
                                                $(`#object_template_${index} #char_parry`).val(charData["characters"][index]["Forced Parry"]);
                                                $(`#object_template_${index} #char_penalty`).val(charData["characters"][index]["Penalty"]);
                                            });
                                        });
                                    });
                                }
                            });
                        });
                    });
                });
                $("#add_object").click(function() {
                    var div_amount = $("#objects").children("div").length + 1;
                    $("#objects").append("<div id='object_template_"+div_amount+"'>" +
                                        objectTemplate);
                });

                // When save is pressed
                $("#save").click(function() {
                    var all_elements = $("#objects").children("div");
                    var character_name;
                    var character_number;
                    $.each(all_elements, function(index, value) {
                        character_number = index + 1;
                        if (accessData[`${current_round}`]["characters"][`${character_number}`] === undefined) {
                            accessData[`${current_round}`]["characters"][`${character_number}`] = jsonTemplate;
                        }
                        accessData[`${current_round}`]["characters"][`${character_number}`] = {
                            "Name": $(`#${$(value).attr("id")} #char_name`).val(),
                            "Attack Quickness": $(`#${$(value).attr("id")} #char_quick`).val(),
                            "Bleed Amount": $(`#${$(value).attr("id")} #char_bleedamt`).val(),
                            "Bleed Duration": $(`#${$(value).attr("id")} #char_bleeddur`).val(),
                            "Total HP": $(`#${$(value).attr("id")} #char_totalhp`).val(),
                            "Current HP": $(`#${$(value).attr("id")} #char_currhp`).val(),
                            "Total Power": $(`#${$(value).attr("id")} #char_totalpp`).val(),
                            "Current Power": $(`#${$(value).attr("id")} #char_currpp`).val(),
                            "Stun Duration": $(`#${$(value).attr("id")} #char_stun`).val(),
                            "Knocked Down": $(`#${$(value).attr("id")} #char_knock`).is(":checked"),
                            "Asleep": $(`#${$(value).attr("id")} #char_asleep`).is(":checked"),
                            "Disarmed": $(`#${$(value).attr("id")} #char_disarm`).is(":checked"),
                            "Forced Parry": $(`#${$(value).attr("id")} #char_parry`).val(),
                            "Penalty": $(`#${$(value).attr("id")} #char_penalty`).val()
                        };
                        localStorage.setItem('charObject', JSON.stringify(accessData));
                    });
                });
    
                // When next is pressed
                $("#next").click(function() {
                    $("#save").click();
                    // Change both values
                    if (current_round == total_round) {
                        current_round++;
                        total_round++;
                    // Change only current round
                    } else {
                        current_round++;
                    }
                    $("#current_round").text(current_round);
                    $("#total_round").text(total_round);
                    accessData[`${current_round}`] = {
                        "characters": {}
                    };
                    localStorage.setItem('charObject', JSON.stringify(accessData));
                });
    
                // When previous round is clicked
                $("#previous").click(function() {
                    // Can't go below round 1
                    if (current_round != 1) {
                        current_round--;
                    }
                    $("#current_round").text(current_round);
                    $("#total_round").text(total_round);
                });
    
                // When clear is clicked
                $("#clear").click(function() {
                    if (current_round > 1 || total_round > 1 || ($("#objects").children("div").length) > 1)
                    current_round = 1;
                    total_round = 1;
                    $("#current_round").text(current_round);
                    $("#total_round").text(total_round);
                    localStorage.removeItem("charObject");
                    $("#objects").empty();
                    $("#objects").append("<div id='object_template_1'>" +
                                        objectTemplate);
                    var createCharObject;
                    $.getJSON('storage.json', function(charJson) {
                        $.each(charJson, function(index, value) {
                            createCharObject = value;
                            localStorage.setItem('charObject', JSON.stringify(createCharObject));    
                            charObject = localStorage.getItem('charObject');
                        });
                    });
                });
    
                // When Save File is clicked
                $("#backup").click(function() {
                    $("<a />", {
                        "download": "myData.json",
                        "href": "data:application/json," + encodeURIComponent(charObject)
                    }).appendTo("body")
                    .click(function() {
                        $(this).remove()
                    })[0].click()
                });
            });
        </script>
    </body>
</html>